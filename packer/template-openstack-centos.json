
{
  "min_packer_version": "0.9.0",
  "variables": {
    "openstack_imgid":  "{{ env `OS_BASE_IMAGE`}}",
    "openstack_sg":     "{{ env `OS_SECURITY_GRP`}}",
    "image_user":       "{{ env `IMAGE_USERNAME`}}",
    "image_name":       "{{ env `IMAGE_NAME`}}",
    "packer_username":  "{{ env `PACKER_USERNAME` }}",
    "packer_password":  "{{ env `PACKER_PASSWORD` }}",
    "preseed":          "{{ env `PRESEED` }}",
  },

  "builders": [
      {
        "type": "openstack",
        "flavor": "b1.medium",
        "image_name": "{{ user `image_name` }}",
        "source_image": "{{ user `openstack_imgid` }}",
        "ssh_username": "{{ user `image_user` }}",
        "use_floating_ip": "true",
        "floating_ip_pool": "nova",
        "ssh_pty" : true,
        "security_groups": "{{user `openstack_sg`}}"
      }
    ],
  "provisioners": [
    {
      "scripts": [
          "{{user `directory`}}/scripts/sudoers.sh",
          "{{user `directory`}}/scripts/install_ansible.sh"
      ],
      "type": "shell",
      "execute_command": " {{ .Vars }} bash '{{ .Path }}'",
      "environment_vars": [ 
          "image={{ user `image_name` }}"
      ]
    },
        {
      "scripts": [
          "{{user `extra_script`}}"
      ],
      "type": "shell",
      "execute_command": "echo '{{user `packer_username`}}' | {{ .Vars }}  sudo -E -S bash '{{ .Path }}'",
      "environment_vars": [ 
          "image={{ user `image_name` }}"
      ]
    },
    {
      "destination": "/tmp/stash",
      "source": "{{user `directory`}}/data/",
      "type": "file"
    },
    {
             "type": "ansible-local",
             "playbook_file": "{{user `packer_directory`}}/ansible/packer.yml",
             "role_paths" :  [ "ansible/roles/sanger-flex-base",
                               "{{user `ansible_rolepath0`}}",
                               "{{user `ansible_rolepath1`}}",
                               "{{user `ansible_rolepath2`}}",
                               "{{user `ansible_rolepath3`}}",
                               "{{user `ansible_rolepath4`}}",
                               "{{user `ansible_rolepath5`}}",
                               "{{user `ansible_rolepath6`}}",
                               "{{user `ansible_rolepath7`}}",
                               "{{user `ansible_rolepath8`}}",
                               "{{user `ansible_rolepath9`}}" ]
    },
    {
      "scripts": [
          "{{user `directory`}}/scripts/add_version.sh",
          "{{user `directory`}}/scripts/install_cloud-init.sh",
          "{{user `directory`}}/scripts/cleanup.sh",
          "{{user `directory`}}/scripts/minimize.sh"
      ],
      "type": "shell",
      "execute_command": "echo '{{user `packer_username`}}' | {{ .Vars }}  sudo -E -S bash '{{ .Path }}'",
      "environment_vars": [ 
          "image={{ user `image_name` }}"
      ]
    }
  ]
}
